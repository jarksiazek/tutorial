### Monitoring ###
* CloudWatch
    * metrics - collect metrics and track key metrics 
    * logs - collect analyze and store log files
    * events - send notification when certain events happen in your AWS 
    * alarms - react in real-time to metric/events
* X-Ray
    * new, not popular
    * troubleshooting application performance and errors
    * distributed tracing of microservices
* CloudTrail
    * internal monitoring of API calls being made 
    * auditing changes to AWS Resources by your users

### Overview 
* Important for 
    * Safely
    * Automatically
    * Using infrastructure as code
    * leveraging the best AWS components 
    * application latency
    * application outage 
    * internal monitoring
    * performance and cost 
    * trends 
    * learning and improving
    
### AWS CloudWatch Metrics
* cloudwatch provides metrics for every services in AWS 
* metric is variable to monitor (CPU Utilization, NetworkIn ...)
* metrics belong to namespaces 
* dimension is an attribute of a metric (instance id, environment, etc)
* up to 10 dimensions per metric 
* metrics have timestamps
* can create dashboards of metrics 

### AWS CloudWatch EC2 Detailed monitoring
* EC2 have metrics every 5 mins 
* with detailed monitoring (for a cost) you can get every 1 min metrics
* use detailed monitoring if you want to more prompt scale your ASG
* Free Tier allows us to have 10 detailed monitoring metrics
* EC2 memory usage is by default not pushed (must be pushed from inside the instance as custom metric)
* Custom metrics 
    * possible to define and send custom metrics to CloudWatch
    * ability to use dimension (attributes) to segment metrics
        * instance.id
        * environment.name
    * metric resolution
        * standard is one minute
        * high resolution up to one sec - high cost
    * use API call PutMetricData
    * exponential backup - when pushing too many data
    
### AWS CloudWatch Alarms
* useful for triggering notification for any metric
* use in Auto Scaling Group, EC2 Actions, SNS notifications
* various options (sampling, %, max, min, etc)
* alarm states: 
    * OK
    * INSUFFICIENT_DATA
    * ALARM
* Period 
    * Length of time in seconds to evaluate the metric
    * high resolution custom metric: can only by 10 sec or 30 sec

### AWS CloudWatch Logs
* application can send logs using SDK
* CloudWatch can collect data from: 
    * ElasticBeanstalk
    * ECS for containers
    * AWS Lambdas
    * VPC flow logs
    * API Gateway
    * Cloudtrail based on filter
    * CloudWatch log aganet: e.g. EC2 machine
    * Route53: Logs DNS queries
* Logs can be stored: 
    * S3 batch exporter for archival
    * Steam to ElasticSearch cluster
* Logs in CloudWatch
    * can use filter expression
    * log store architecture:
        * log groups: arbitrary name, usually representing an application
        * log streams: instances within application/log files/containers
    * log expiration policy (never expire, 30 days, etc)
    * using the AWS CLI we can tail CloudWatch logs: 
    * Sending logs to CloudWatch be sure to have correct AIM permissions
    * Security: encryption of logs using KMS at the Group Level

### AWS CloudWatch Agent
* By default, no logs from EC2 will go to CloudWatch
* To store logs from EC2 you need to start CloudWatch agent (small program for sending logs)
* make sure AIM permissions are correct
* CloudWatch Logs Agent vs Unified Agent 
    * logs agent 
        * collect logs application (servers, on premises servers)
        * can send logs to CloudWatch Logs
    * unified agent
        * same as logs agent can do 
        * the new one version of agent 
        * can collect system-level metrics like RAM, CPU
        * Centralized configuration using SSM Parameter Store

### AWS CloudWatch Logs Metric Filter
* can use filter expression 
    * e.g. find a specific IP inside the logs
    * or count occurrences of "ERROR" in your logs
    * metric filters can be used for trigger alarm
* Filters only publish the metric data points for events that happen after the filter was created

### AWS CloudWatch Logs Events
* Schedule: CRON jobs
* Event pattern: Event rules to react to a service doing something
    * e.g. CodePipeline was changed 
* Can trigger Lambda function, SQS/SNS 
* When triggered, CloudWatch Event creates small JSON to give your more information

### AWS EventBridge
* Next evolution of CloudWatch Events
* Default event bus: generated by AWS services (CloudWatch Events)
* On EventBridge we can add additional event buses: 
    * Partner event bus: receive events from SaaS service or applications (Zendesk, DataDog, Segment, AuthO, ect)
    * Custom event bus: for your own applications
    * event buses can be accessed by other AWS accounts 
    * can create rules how to process the events (similar to CloudWatch events)

### AWS EventBridge Schema Registry
* EventBridge can analyze the events in your bus and infer the schema
* The schema Registry allows you to generate code for your application that will know in advance how data is structured in the event bus

### EventBridge vs CloudWatch Event
* EventBridge builds upon and extends CloudWatch Events
* Uses the same API and endpoint, and the same underlying service infrastructure
* EventBridge allows extension to add event buses for your custom applications and your third-party SaaS app.
* EventBridge has the Schema Registry capability
* EventBridge has a different name to mark the new capabilities
* Over time CloudWatch will be replaced with EventBridge
  
  
### X-Ray
* Visual analysis of your application
* recommended specially for microservices
* Easy to troubleshooting performance
* Understand dependencies in a microservice architecture
* Pinpoint request behaviour
* Find errors and exceptions
* Are we meeting time SLA
* Identifying users that are impacted

### X-Ray Compatibility
* AWS Lambda
* Elastic Beanstalk
* ECS
* ELB
* API Gateway
* EC2 instances or any applications (even on premise)

### X-Ray Tracing
* Tracing is an end to end way to following a "request"
* each component dealing with the request adds its own "trace"
* Tracing is made of segments (+sub segments)
* Annotations can be added to traces to provide extra-information
* Ability to trace:
    * every request
    * sample request (as a % for example or a rate per minute)
* X-ray security
    * IAM for authorization
    * KMS for encryption at rest

### X-Ray How to enable?
1. Your code (Java, Python, Go, Node.js, NET) must import the AWS X-Ray SDK 
    * very small code modification needed
    * the application SDK will then capture: 
        * Calls to AWS services
        * HTTP/HTTPS requests
        * Database calls (MySQL, PostgreSQL, DynamoDB)
        * Queue calls (SQS)
2. Install the X-ray daemon or enable X-Ray AWS Integration
    * X-ray daemon works as a low level UDP packet interceptor (Linux/Win/Mac)
    * AWS Lambda/other AWS services already run the X-Ray daemon for you
    * Each application must have the IAM right to write data on X-ray

### X-Ray troubleshooting
* If X-ray not working on EC2
    * Ensure the EC2 Role has proper permissions
    * Ensure the EC2 instance is running the X-ray Daemon
* To enable on Lambda 
    * ensure it has an IAM execution role with proper policy (AWSX_RayWriteOnlyAccess)
    * ensure that X-Ray is imported in the code
    
### X-Ray instrumentation
* Instrumentation means the measure of product's performance, diagnose errors, and to write trace information
* to instrument your application code, use the X-Ray SDK
* many SDK require only configuration changes 
* you can modify your application code to customize and annotation the data that the SDK sends to X-ray, using interceptors, filters, middleware 

### X-Ray concept
* segments: each application/service will send them 
* subsegments: if you need more details in your segment
* trace: segments collected together to form an end-to-end trace
* sampling: decrease te amount of request sent to X-ray, reduce cost
* annotations: key value pairs used to index traces and use with filters
* metadata: key value pairs, not indexed, not used for searching

### X-Ray sampling
* default rules
    * control the amount of data that you record
    * you can modify sampling rules without changing the code
    * by default, the X-ray SDK records the first request each second, and five percent of additional requests
    * one request per second is the reservoir, which ensures that at least one trace is recorded each second as long as the service is serving requests
    * five percent is the rate at which additional requests beyond the reservoir size are sampled
* Custom sampling rules
    * rules for a reservoir and rate
    * we can add more data or reduce
    * max is reservoir = 1 and rate = 1
    
### X-Ray API, rights
* Write Policy
    * PutTraceSegments: upload segment document to AWS X-Ray
    * PutTelemetryRecords: used by AWS, X-Ray records to upload telemetry
        * Segments received, rejected, backendConnectionErrors
    * GetSamplingRules: retrieving all segment rules
    * GetSamplingStatisticSummaries: advanced
* Read policy
    * GetServiceGraph - main graph
    * BatchGetTraces - batch traces collections of segment documents
    * GetTraceSummaries - retrieves IDs and annotations for traces available for a specified time
    * GetTraceGraph - retrieves a service graph for one or more specific traces

### X-Ray with Beanstalk
* AWS Beanstalk includes the X-ray - daemon installed
* you can run daemon by setting an option or configure .ebextension/xray-daemon.config
* make sure to give your instance profile the correct IAM 
* make sure that your application code is instrumented with SDK X-ray
* X-ray daemon is not provided for multicontainer docker

### X-Ray with ECS
* X-ray container as daemon - ECS Cluster
    * if you run 10 EC2 you need to have 10 x-ray daemons - one per container
* X-Ray container as a "Side Car" - ECS Cluster
    * one application in EC2 needs one x-ray daemon - 
* X-Ray container as a "Side Car" - Fargate
    * x-ray per application - app container
    
### AWS CloudTrail
* the simples 
* provides governance, compliance and audit for your AWS account 
* cloudtrail enable by default
* get a history of events/ API calls made within your AWS account by: 
    * Console, SDK, CLI, AWS Services
* Can put logs from CloudTrail into CloudWatch Logs







    
    
   
        



  



    


  
    
    
    

         

      